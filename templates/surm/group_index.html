{% extends "base.html" %}
{% load bootstrap3 %}
{% load static from staticfiles %}

{% block additional_static %}
<link href="{% static 'css/group_index.css' %}" rel="stylesheet">
<script src="{% static 'js/jquery.js' %}"></script>
<script src="{% static 'js/csrf_token_ajax.js' %}"></script>
<script src="{% static 'js/group_index.js' %}"></script>
{% endblock %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
    <h2>{{ group.name }}</h2>
    <div class="group_info">
        <p>作成日 : {{ group.created }}</p>
        {% if group.explain %}
        <p>{{ group.explain }}</p>
        {% else %}
        
        {% endif %}
        {% if user.id == group.creater.id %}
        <a href="{% url 'surm.views.group_settings' group_id=group.id %}" class="btn btn-sm btn-primary"><i class="fa fa-cog"></i> グループの設定</a>
    </div>
    <br />
    {% endif %}
    参加者: {{ join_users | length }}人 <br />
    <table class="table table-striped">
        <tr>
            <th>ユーザ名</th>
            <th>メールアドレス</th>
            <th>最終ログイン</th>
            <th>役割</th>
        </tr>
        {% for join_user in join_users %}
        <tr>
            <td>
                {{ join_user.username }}
            </td>
            <td>
                {{ join_user.email }}
            </td>
            <td>
                {{ join_user.last_login }}
            </td>
            <td>
                {% if join_user.id == group.creater.id %}
                <span class="label label-primary">作成者</span> <span class="label label-info">管理者</span>
                {% else %}
                <span class="label label-default">一般ユーザ</span>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </table>
    
    {% if user.is_superuser or user.id == group.creater.id %}
    <a href="{% url 'surm.views.add_group_member' group_id=group.id %}" class="btn btn-sm btn-success"><i class="fa fa-users"></i> ユーザをグループに追加</a>
    {% endif %}
    
    <hr />
    
    <h4>自分のお気に入り</h4>
    <table class="table">
        <tr>
            <th>お気に入り日時</th>
            <th>リソース名</th>
        </tr>
        {% for my_favorite_resource in my_favorite_resources %}
        <tr>
            <td>{{ my_favorite_resource.favorited }}</td>
            <td><a href="{{ my_favorite_resource.resource.url }}" class="post_resource_btn" id="{{ my_favorite_resource.resource.id }}" target="_blank">{{ my_favorite_resource.resource.name }}</a></td>
        </tr>
        {% endfor %}
    </table>

    <h4>グループ内のお気に入り履歴</h4>
    <table class="table">
        <tr>
            <th>お気に入り日時</th>
            <th>ユーザ名</th>
            <th>リソース名</th>
        </tr>
        {% for favorite_resource in favorite_resources_history %}
        <tr>
            <td>{{ favorite_resource.favorited }}</td>
            <td>{{ favorite_resource.user.username }}</td>
            <td><a href="{{ favorite_resource.resource.url }}" class="post_resource_btn" id="{{ favorite_resource.resource.id }}" target="_blank">{{ favorite_resource.resource.name }}</a></td>
        </tr>
        {% endfor %}
    </table>
    
    <hr />
    <form action="{% url 'surm.views.group_index' group_id=group.id %}" method="post" class="form resource_add_form">
        {% csrf_token %}
        {% bootstrap_form form %}
        <button type="submit" class="btn btn-default">Submit</button>
    </form>
    
    <h4>投稿されたリソース一覧</h4>
    {% if resources %}
        <ul class="posted_resources">
        {% for resource in resources %}
            <li class="posted_resource">
                <button class="link_btn post_resource_btn" id="{{ resource.id }}" onclick="window.open('{{ resource.url }}')">{{ resource.name }}</button>
                <button class="fav_button icon_button" id="{{ resource.id }}"><i class="fa fa-star"></i></button>
                {% if user.id == resource.creater.id %}
                <button class="dlt_button icon_button" id="{{ resource.id }}"><i class="fa fa-times"></i></button>
                {% endif %}
                <ul class="posted_resource_info">
                    <li>投稿日時 : {{ resource.created }}</li>
                    <li>投稿者 : {{ resource.creater.username }}</li>
                    <li>閲覧数 : {{ resource.view }}</li>
                    <li>閲覧者 : 
                        {% for read_user in read_users %}
                            {% if read_user.resource == resource %}
                                {{ read_user.user.username }},
                            {% endif %}
                        {% endfor %}
                    </li>
                    {% if resource.memo %}
                    <li>メモ: {{ resource.memo }}</li>
                    {% endif %}
                </ul>
                <hr />
            </li>
        {% endfor %}
        </ul>
    {% else %}
        <p>投稿されたリソースはありません</p>
    {% endif %}
{% endblock %}