{% extends "base.html" %}
{% load bootstrap3 %}
{% load static from staticfiles %}

{% block additional_static %}
<link href="{% static 'css/group_index.css' %}" rel="stylesheet">
<script src="{% static 'js/jquery.js' %}"></script>
<script src="{% static 'js/csrf_token_ajax.js' %}"></script>
<script src="{% static 'js/group_index.js' %}"></script>
{% endblock %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
    <h2>{{ group.name }}</h2>
    <div class="group_info">
        <p>作成日 : {{ group.created }}</p>
        {% if group.explain %}
        <p>{{ group.explain }}</p>
        {% else %}
        
        {% endif %}
        {% if user.id == group.creater.id %}
        <a href="{% url 'surm.views.group_settings' group_id=group.id %}" class="btn btn-sm btn-primary"><i class="fa fa-cog"></i> グループの設定</a>
        {% endif %}
    </div>
    <hr />
    <div class="row">
        <div class="col-sm-3">
            <div class="group_info">
                <ul class="list-inline">
                    <li><h4>参加者: {{ join_users | length }}人</h4></li>
                {% if user.is_superuser or user.id == group.creater.id %}
                    <li><a href="{% url 'surm.views.add_group_member' group_id=group.id %}" class="btn btn-xs btn-success add_member_btn"><i class="fa fa-users"></i> 追加</a></li>
                {% endif %}
                </ul>
                <ul class="join_users">
                    {% for join_user in join_users %}
                        <li><span class="username">{{ join_user.username }}</span>
                            {% if join_user.id == group.creater.id %}
                                <span class="label label-primary">作成者</span> <span class="label label-info">管理者</span>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            </div>
            
            <div class="registered_tags">
                <h4>登録されたタグ</h4>
                <ul>
                    {% for group_tag in group_tags %}
                        <li><a href="{% url 'surm.views.tag_filtering' group_id=group.id tag_id=group_tag.id %}">{{ group_tag.tag }}({{ group_tag.tagresource_set.all.count }})</a></li>
                    {% endfor %}
                </ul>
            </div>
            
            <div class="favorite_info">
                <h4>お気に入り履歴</h4>
                <table class="table">
                    <tr>
                        <th>ユーザ名</th>
                        <th>リソース名</th>
                    </tr>
                    {% for favorite_resource in favorite_resources_history %}
                    <tr>
                        <td>{{ favorite_resource.user.username }}</td>
                        <td><a href="{{ favorite_resource.resource.url }}" class="post_resource_btn" id="{{ favorite_resource.resource.id }}" target="_blank">{{ favorite_resource.resource.name }}</a></td>
                    </tr>
                    {% endfor %}
                </table>
            </div>
        </div>
        <div class="col-sm-9">
            
            <h4>自分のお気に入り</h4>
            <table class="table">
                <tr>
                    <th>お気に入り日時</th>
                    <th>リソース名</th>
                    <th>タグ</th>
                </tr>
                {% for my_favorite_resource in my_favorite_resources %}
                <tr>
                    <td>{{ my_favorite_resource.favorited }}</td>
                    <td><a href="{{ my_favorite_resource.resource.url }}" class="post_resource_btn" id="{{ my_favorite_resource.resource.id }}" target="_blank">{{ my_favorite_resource.resource.name }}</a></td>
                    <td>
                        {% for tag in my_favorite_resource.resource.tagresource_set.all %}
                            {{ tag.tag.tag }},
                        {% endfor %}
                    </td>
                </tr>
                {% endfor %}
            </table>
            
            <hr />
            <form action="{% url 'surm.views.group_index' group_id=group.id %}" method="post" class="form resource_add_form">
                {% csrf_token %}
                {% bootstrap_form form %}
                <button type="submit" class="btn btn-default">Submit</button>
            </form>
            
            <h4>投稿されたリソース一覧</h4>
            {% if resources %}
                <ul class="posted_resources">
                {% for resource in resources %}
                    <li class="posted_resource">
                        <button class="link_btn post_resource_btn" id="{{ resource.id }}" onclick="window.open('{{ resource.url }}')">{{ resource.name }}</button>
                        <button class="fav_button icon_button" id="{{ resource.id }}"><i class="fa fa-star"></i></button>
                        {% if user.id == resource.creater.id %}
                        <button class="dlt_button icon_button" id="{{ resource.id }}"><i class="fa fa-times"></i></button>
                        {% endif %}
                        <ul class="posted_resource_info">
                            <li>投稿日時 : {{ resource.created }}</li>
                            <li>投稿者 : {{ resource.creater.username }}</li>
                            <li>閲覧数 : {{ resource.view }}</li>
                            <li>閲覧者 : 
                                {% for read_user in resource.resourceuserview_set.all %}
                                    {{ read_user.user.username }},
                                {% endfor %}
                            </li>
                            <li>お気に入り数: {{ resource.resourceuserfavorite_set.all.count }}</li>
                            <li>
                                タグ:
                                {% for tag in resource.tagresource_set.all %}
                                    {{ tag.tag.tag }},
                                {% endfor %}
                            </li>
                            {% if resource.memo %}
                            <li>メモ: {{ resource.memo }}</li>
                            {% endif %}
                        </ul>
                        <hr />
                    </li>
                {% endfor %}
                </ul>
            {% else %}
                <p>投稿されたリソースはありません</p>
            {% endif %}
        </div>
    </div>
{% endblock %}